---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DBI)
library(dragracer)
library(glue)
library(here)
library(flexdashboard)
library(googlesheets4)
source(here("Functions","db_helper_functions.R"))
```


```{r manuall set the date columns to characters}
# This is way different from the flavors of SQL I am used to... this is not my
# ideal route but it gets the job done. Could potentially create lookup tables
# with all of the dates based off of season/episode and dob but it seems a bit much
# Will have to update the table definitions so that there is some documentation
# noting the workaround that is taken in R.... alternatively I could just delete all of the tables
# and rewrite them with the as.character mutate. Analysis first, make pretty later
rpdr_conn <- DBI::dbConnect(RSQLite::SQLite(), dbname="rpdr.sqlite")
rpdr_final_tbl <- db_exec_query(  db_conn = rpdr_conn
                        , file_location = "SQL"
                        , file_name = "rpdr_final_table_defn.sql") %>% 
  mutate(  airdate=as.character(lubridate::as_date(airdate))
         , dob=as.character(lubridate::as_date(dob)))


  DBI::dbWriteTable(conn=rpdr_conn, name="rpdr_hist", value=rpdr_final_tbl, append=TRUE, row.names=FALSE)
DBI::dbDisconnect(rpdr_conn)
```


```{r}
library(googlesheets4)
googlesheets4::gs4_deauth()
data_for_prog_url <- "https://docs.google.com/spreadsheets/d/1Sotvl3o7J_ckKUg5sRiZTqNQn3hPqhepBSeOpMTK15Q/"
all_social_media <- read_sheet(data_for_prog_url, sheet="all_social_media", skip = 1, col_names = TRUE, col_types = "cDdd")
```

```{r}
all_social_media <- all_social_media %>% 
  rename(  contestant_id=1
         , date_pulled=2
         , twitter_followers=3
         , instagram_followers=4
         )
```
```{r}
saveRDS(all_social_media,here("Input","all_social_media.RDS"))
saveRDS(data_for_prog_episodes,here("Input","all_episodes.RDS"))
```


```{r Read in RDS from input and ETL for sqlite}
file_list <- list.files(("Input"))

for (data_set in file_list){
  df_name <- str_remove(data_set,".RDS")
  assign(df_name, value = readRDS(file = here("Input",data_set)), envir = .GlobalEnv)
  #readRDS(here("Input",data_set))
}

```


```{r test join betweeen drag racer and Data for Prog}
rpdr_conn <- DBI::dbConnect(RSQLite::SQLite(), dbname="rpdr.sqlite")

DBI::dbWriteTable(conn=rpdr_conn, name="dp_contestants", value=all_contestants, append=TRUE, row.names=FALSE)

DBI::dbWriteTable(conn=rpdr_conn, name="dp_ranking", value=all_rankings, append=TRUE, row.names=FALSE)

DBI::dbWriteTable(conn=rpdr_conn, name="dp_social", value=all_social_media, append=TRUE, row.names=FALSE)

DBI::dbDisconnect(rpdr_conn)
```

